<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="https://godidier.github.io/theme/css/style.less">
  <script src="//cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->
  <link rel="icon" type="image/vnd.microsoft.icon" href="https://godidier.github.io/">
  <link rel="stylesheet" type="text/css" href="https://godidier.github.io/theme/css/normalize.css">
  <link rel="stylesheet" type="text/css" href="https://godidier.github.io/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="https://godidier.github.io/theme/css/pygments.css">
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Roboto+Mono">
  <link rel="stylesheet" type="text/css" href="https://godidier.github.io/theme/css/fontawesome-all.min.css">
  <link rel="stylesheet" type="text/css" href="https://godidier.github.io/theme/css/hatena-bookmark-icon.css">
  <link rel="stylesheet" type="text/css" href="/static/custom.css">


  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Didier Gohourou">
  <meta name="description" content="Posts and writings by Didier Gohourou">


<meta name="keywords" content="">

  <title>
    [GTR]
&ndash; Building a Simple TORCS AI Agent (3/10): Brakes and Gears  </title>

</head>

<body>
  <main>
    <header>
      <div class="site-name">
        <a href="https://godidier.github.io">[GTR]  <br/> Godidier's Technical Report</a>
      </div>
      <p>
        <a href="https://godidier.github.io/archives.html"><i class="fab fas-archive"></i> Archive</a>
      </p>
	  <ul class="menuitems">   
          <li><a href="https://godidier.github.io/#">Here</a></li>
          <li><a href="https://godidier.github.io/#">And there</a></li>
	  </ul>
    </header>

<article>
  <div class="article__title">
    <h1><a href="https://godidier.github.io/drafts/torcs-ai-tuto-3.html">Building a Simple TORCS AI Agent (3/10): Brakes and Gears</a></h1>
  </div>
  <div class="article__meta">
    <p class="article__meta__post-date">Posted on: 日 09 12月 2018</p>
    </p>
  </div>
  <div class="article__text">
    <p>This is the third chapter of a tutorial for building an AI agent for the racing 
game TORCS. In this chapter, we will learn to break, change gears and drive
faster.</p>
<ul>
<li><a href="https://godidier.github.io/drafts/torcs-ai-tuto-1.html#table_of_contents">Table of Contents</a></li>
<li><a href="https://godidier.github.io/drafts/torcs-ai-tuto-2.html">Previous: Acceleration</a></li>
<li><a href="#">Brakes and Gears</a><ul>
<li><a href="#">Title</a></li>
<li><a href="#">Title</a></li>
</ul>
</li>
<li><a href="https://godidier.github.io/drafts/torcs-ai-tuto-4.html">Next: Steering and Trajectory</a></li>
</ul>
<h1>Accelerating the right way</h1>
<p>Maybe you are expecting that because we will learn to brake, we can set the 
accelerator to 1.0 whenever we move forward right?! I am afraid we can't !
We cannot go full speed on every section of a track. If our car is on a straight 
line then we can do whatever we want to the accelerator, meaning  we can just 
set it to 1.0 (<del>Your dream is realized!</del>). But on a turn section, 
there is a limited amount of speed we have to respect. Otherwise, we migth 
<strong>understeer</strong> and go off road.</p>
<p>Understeer?... Here is a quote from 
<a href="https://en.wikipedia.org/wiki/Understeer_and_oversteer">Wikipedia</a> to the rescue.</p>
<blockquote>
<p>Understeer and oversteer are vehicle dynamics terms used to describe the 
sensitivity of a vehicle to steering. Oversteer is what occurs when a car turns 
(steers) by more than the amount commanded by the driver. Conversely, understeer 
is what occurs when a car steers less than the amount commanded by the driver. </p>
</blockquote>
<p><img alt="Understeer and Oversteer" src="https://godidier.github.io/images/2018-12/understeer-oversteer.png"></p>
<p>So we need to know what amount of speed we can apply to safely pass a turn.
We will resort to an equation from physics. <del>Stay with me</del>. </p>
<div class="math">$$ {mv^2 \over r} = {mg\mu} $$</div>
<p>Where: </p>
<ul>
<li><span class="math">\(m\)</span> : is the current car mass (kg)</li>
<li><span class="math">\(v\)</span> : current speed (m/s)</li>
<li><span class="math">\(r\)</span> : radius of the turn's segment(m) </li>
<li><span class="math">\(\mu\)</span> : friction coefficient</li>
<li><span class="math">\(g\)</span> : the gravity of earth 9.80665 (m/s^2)</li>
</ul>
<p>The left part of the equation is the <strong>centrifugal force</strong> and the left side is 
the <strong>centripetal force</strong> created by the friction of the turning wheels of our 
car. 
Here is a quote from an 
<a href="https://www.diffen.com/difference/Centrifugal_Force_vs_Centripetal_Force">article</a> 
that explain those two forces. </p>
<blockquote>
<p>Centrifugal force (Latin for "center fleeing") describes the tendency of an 
object following a curved path to fly outwards, away from the center of the 
curve. It's not really a force; it results from inertia — the tendency of an 
object to resist any change in its state of rest or motion. Centripetal force 
is a real force that counteracts the centrifugal force and prevents the object 
from "flying out," keeping it moving instead with a uniform speed along a 
circular path. </p>
</blockquote>
<p>Let's picture what we are talking about.</p>
<p><img alt="Centrifugal and Centripetal forces" src="https://godidier.github.io/images/2018-12/centrifugal-centripetal.png"></p>
<p>We find the appropriate speed by expressing <span class="math">\(v\)</span> from the equation above, which 
yield:</p>
<div class="math">$$ v = \sqrt{g \mu r} $$</div>
<p>This is a simplified version of the real appropriate speed value. We assume that 
all wheels have the same <span class="math">\(\mu\)</span>, and the weight is equally distributed over all 
wheels. The coefficient <span class="math">\(\mu\)</span> with the friction coefficient which normally is 
a function with many parameters includind the relative speed vector between the<br>
surfaces, the current load, the shape of the patch, the temperature, etc.</p>
<p>With our result, let's create a function that returns the appropriate (allowed) 
speed on a segment of the track. We declare it in <em>carcontroller.h</em> within the 
<code>CarController</code> class interface. </p>
<div class="highlight"><pre><span></span><span class="kt">float</span>  <span class="n">CarController</span><span class="o">::</span><span class="n">GetAllowedSpeed</span><span class="p">(</span><span class="n">tTrackSeg</span><span class="o">*</span> <span class="n">segment</span><span class="p">);</span>
</pre></div>


<p>and define it in <em>carcontroller.cpp</em>. </p>
<div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Compute the allowed speed on a segment.</span>
<span class="cm"> * */</span>
<span class="kt">float</span>  <span class="n">CarController</span><span class="o">::</span><span class="n">GetAllowedSpeed</span><span class="p">(</span><span class="n">tTrackSeg</span><span class="o">*</span> <span class="n">segment</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TR_STR</span><span class="p">){</span>
        <span class="k">return</span> <span class="n">FLT_MAX</span><span class="p">;</span> <span class="c1">// Max float number </span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="kt">float</span> <span class="n">mu</span> <span class="o">=</span> <span class="n">segment</span><span class="o">-&gt;</span><span class="n">surface</span><span class="o">-&gt;</span><span class="n">kFriction</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">r</span> <span class="o">=</span> <span class="n">segment</span><span class="o">-&gt;</span><span class="n">radius</span><span class="p">;</span>
        <span class="k">return</span> <span class="nf">sqrt</span><span class="p">(</span><span class="n">mu</span> <span class="o">*</span> <span class="n">G</span> <span class="o">*</span> <span class="n">r</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p><code>TR_STR</code> is a straight segment, there is also <code>TR_RGT</code> for a right curve and 
<code>TR_LFT</code> for a left curve, from <em>track.h</em>.</p>
<p>To prevent the car from going over the allowed speed of a given segment, we need 
to know how much throttle to apply on the acceleretor pedal. In TORCS the 
acceleration throttle value is between 0 and 1, and can be deduced by 
normalizing the car engine's given revolution per minute (rpm) by its rpm redline
i.e the maximum revolution per minute the car's engine can operate at.</p>
<div class="math">$$
accelerator\ throttle = \frac{rpm}{rpm\ redline} 
$$</div>
<p>If we also express the angular speed of the wheel <span class="math">\(\omega = \theta / t\)</span> 
with the linear speed <span class="math">\(v = \omega \times \theta\)</span> we have <span class="math">\(\omega = v / r\)</span>
Since the angular speed is also equal to the rpm divided by the gear ratio, 
we have the following relation: </p>
<div class="math">$$
\begin{align*}
\frac{v}{r}&amp; = \frac{rpm}{gear\ ratio} \\
rpm&amp; = \frac{v \times gear\ ratio}{r} 
\end{align*}
$$</div>
<p>Where </p>
<ul>
<li><span class="math">\(v\)</span> is the speed of the car (m/s)</li>
<li><span class="math">\(r\)</span> is the radius of the spinning wheel (m)</li>
<li><span class="math">\(rpm\)</span> ie the engine's revolution per minute (rad/s)</li>
<li><span class="math">\(gear\ ratio\)</span> the ratio of the angular velocity fo input gear (engine's rpm) 
and the angular velocity output gear (the wheel). </li>
</ul>
<p>We obtain the desired accelerator throttle by plugin the expression of <span class="math">\(rpm\)</span> 
into the one of the <span class="math">\(accelerator\ throttle\)</span>. </p>
<div class="math">$$
accelerator\ throttle = \frac{(v \times gear\ ratio) / r}{rpm\ redline}
$$</div>
<p>We rewrite the <code>GetAcceleration()</code> method with the result. It basically says 
if with our current speed we can accelerate to the max without stepping over 
the allowed speed of the segment, we go full throttle. Else, we compute the 
right amount of  of throttle to apply on the accelerator pedal.</p>
<div class="highlight"><pre><span></span><span class="kt">float</span> <span class="n">CarController</span><span class="o">::</span><span class="n">GetAcceleration</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">float</span> <span class="n">acceleration</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">allowed_speed</span> <span class="o">=</span> <span class="n">GetAllowedSpeed</span><span class="p">(</span><span class="n">car</span><span class="o">-&gt;</span><span class="n">_trkPos</span><span class="p">.</span><span class="n">seg</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">allowed_speed</span> <span class="o">&gt;</span> <span class="n">car</span><span class="o">-&gt;</span><span class="n">_speed_x</span> <span class="o">+</span> <span class="n">ACCELERATION_MARGIN</span><span class="p">){</span>
        <span class="n">acceleration</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="kt">float</span> <span class="n">gear_ratio</span> <span class="o">=</span> <span class="n">car</span><span class="o">-&gt;</span><span class="n">_gearRatio</span><span class="p">[</span><span class="n">car</span><span class="o">-&gt;</span><span class="n">_gear</span> <span class="o">+</span> <span class="n">car</span><span class="o">-&gt;</span><span class="n">_gearOffset</span><span class="p">];</span>
        <span class="kt">float</span> <span class="n">rpm_redline</span> <span class="o">=</span> <span class="n">car</span><span class="o">-&gt;</span><span class="n">_enginerpmRedLine</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">wheel_radius</span> <span class="o">=</span> <span class="n">car</span><span class="o">-&gt;</span><span class="n">_wheelRadius</span><span class="p">(</span><span class="n">REAR_RGT</span><span class="p">);</span>
        <span class="n">acceleration</span> <span class="o">=</span> <span class="p">(</span><span class="n">allowed_speed</span> <span class="o">*</span> <span class="n">gear_ratio</span> <span class="o">/</span> <span class="n">wheel_radius</span><span class="p">)</span> <span class="o">/</span> <span class="n">rpm_redline</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">acceleration</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>We finish this part by defining the constants G (gravity) and FULL_THROTTLE 
in <em>carcontroller.cpp</em>.</p>
<div class="highlight"><pre><span></span><span class="k">const</span> <span class="kt">float</span> <span class="n">CarController</span><span class="o">::</span><span class="n">G</span> <span class="o">=</span> <span class="mf">9.81</span><span class="p">;</span> <span class="c1">// [m/s^2]</span>
<span class="k">const</span> <span class="kt">float</span> <span class="n">CarController</span><span class="o">::</span><span class="n">ACCELERATION_MARGIN</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span> <span class="c1">// [m/s]</span>
</pre></div>


<p>and we define them in <em>carcontroller.h</em> among the public element of the 
<code>CarController</code> class.</p>
<div class="highlight"><pre><span></span>        <span class="k">static</span> <span class="k">const</span> <span class="kt">float</span> <span class="n">G</span><span class="p">;</span>
        <span class="k">static</span> <span class="k">const</span> <span class="kt">float</span> <span class="n">ACCELERATION_MARGIN</span><span class="p">;</span>
</pre></div>


<h1>Braking Basics</h1>
<h2>Checking the distance</h2>
<p>As we previously saw, there is a speed limitation for turn segments. If we 
approach a turn segment at a speed higher than the allowed speed of that turn 
segment, we need to reduce our speed to the given allowed speed, before engaging 
that turn segment. For that, we need to brake. </p>
<p>We need to know in advance when to apply the brakes. i.e. at what distance from the 
turn we have to start braking. We can compute the braking distance using the 
following equation of energies. </p>
<div class="math">$$
\underbrace{\frac{m \cdot v_1^2}{2}}_{\text{Current kinetic energy}} - \underbrace{\frac{m \cdot v_2^2}{2}}_{\text{Desired kinetic energy}} = \underbrace{m \cdot g \cdot \mu \cdot s}_{\text{Energy 'burned' by the brakes over distance s}}
$$</div>
<p>Where </p>
<ul>
<li><span class="math">\(m\)</span> is the mass of the car (kg)</li>
<li><span class="math">\(v_1\)</span> is the current speed of the car (m/s)</li>
<li><span class="math">\(v_2\)</span> is the allowed speed on the turn segment, or targeted portion of the track
 (m/s)</li>
<li><span class="math">\(g\)</span> is the gravity constant</li>
<li><span class="math">\(\mu\)</span> is the friction coefficient </li>
<li><span class="math">\(s\)</span> is the distance necessary to brake (m)</li>
</ul>
<p>We have </p>
<div class="math">$$
s = \frac{v_1^2 - v_2^2}{2 \cdot g \cdot \mu}
$$</div>
<p>We also need a mechanism to gradually look ahead from the current position of 
the car to a potential segment with an allowed speed lower than the current speed 
of the car, up to a given distance. The lookahead mechanism will start with the 
distance from the car to the end of the current segment. Let's implement a utility 
function to get this initial distance. </p>
<p>in <em>carcontroller.cpp</em> add</p>
<div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Measure the distance from the current position of the car </span>
<span class="cm"> * to the end of the segment the car is on.</span>
<span class="cm"> */</span>
<span class="kt">float</span> <span class="n">CarController</span><span class="o">::</span><span class="n">DistanceFromCarToSegmentEnd</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">auto</span> <span class="n">car_position</span> <span class="o">=</span> <span class="n">car</span><span class="o">-&gt;</span><span class="n">_trkPos</span><span class="p">;</span>
    <span class="k">auto</span> <span class="n">segment</span> <span class="o">=</span> <span class="n">car_position</span><span class="p">.</span><span class="n">seg</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TR_STR</span><span class="p">){</span>
        <span class="k">return</span> <span class="n">segment</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="n">car_position</span><span class="p">.</span><span class="n">toStart</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">arc</span> <span class="o">-</span> <span class="n">car_position</span><span class="p">.</span><span class="n">toStart</span><span class="p">)</span> <span class="o">*</span> <span class="n">segment</span><span class="o">-&gt;</span><span class="n">radius</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>As you might see, if the segement is a straight, we simply do a substraction else 
the arc of the radius comes into play.</p>
<p>Note that the maximum distance up to which we check for a turn to slow down is 
a special case of the distance formula <span class="math">\(s\)</span> where <span class="math">\(v_2 = 0\)</span>. Meaning in case 
we have to completely stop the car. This yield <span class="math">\(s = v_1^2 / (2 \cdot g \cdot \mu)\)</span></p>
<p>The illustration below gives an idea of the 'look ahead' mechanism. </p>
<p><img alt="Look ahead" src="{static}/#"></p>
<h2>Braking</h2>
<p>We will now implement our breaking mechanism. In case we are on a segment with a 
speed higher than the allowed speed on that segment, we brake. Otherwise we first 
consider a maximum distance up to which we check for turns that requires to 
decrease our speed. Then we gradually 'look ahead' up to that maximum distance 
for potential turns for which we need to slow down. If we find one, we check 
if the required distance we need to brake to match the allowed speed of that 
turn is greater than the distance we currently are (looking ahead) to that turn. 
If so we apply the brake. For every other conditions, we do not brake.</p>
<p>Here is the implementation of basic braking in <em>carcontroller.cpp</em></p>
<div class="highlight"><pre><span></span><span class="kt">float</span> <span class="n">CarController</span><span class="o">::</span><span class="n">GetBrake</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">float</span> <span class="n">brake</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="n">tTrackSeg</span><span class="o">*</span> <span class="n">segment</span> <span class="o">=</span> <span class="n">car</span><span class="o">-&gt;</span><span class="n">_trkPos</span><span class="p">.</span><span class="n">seg</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">car</span><span class="o">-&gt;</span><span class="n">_speed_x</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">allowed_speed</span> <span class="o">=</span> <span class="n">GetAllowedSpeed</span><span class="p">(</span><span class="n">segment</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">mu</span> <span class="o">=</span> <span class="n">segment</span><span class="o">-&gt;</span><span class="n">surface</span><span class="o">-&gt;</span><span class="n">kFriction</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">look_ahead_distance_max</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">speed</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">*</span> <span class="n">G</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">look_ahead_distance</span> <span class="o">=</span> <span class="n">DistanceFromCarToSegmentEnd</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">allowed_speed</span> <span class="o">&lt;</span> <span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">brake</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">segment</span> <span class="o">=</span> <span class="n">segment</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="n">look_ahead_distance</span> <span class="o">&lt;</span> <span class="n">look_ahead_distance_max</span><span class="p">){</span>
        <span class="n">allowed_speed</span> <span class="o">=</span> <span class="n">GetAllowedSpeed</span><span class="p">(</span><span class="n">segment</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">allowed_speed</span> <span class="o">&lt;</span> <span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">float</span> <span class="n">brake_distance</span> <span class="o">=</span> 
                    <span class="p">(</span><span class="n">pow</span><span class="p">(</span><span class="n">speed</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">pow</span><span class="p">(</span><span class="n">allowed_speed</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">*</span> <span class="n">G</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">brake_distance</span> <span class="o">&gt;</span> <span class="n">look_ahead_distance</span><span class="p">){</span>
                <span class="n">brake</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> 
        <span class="n">look_ahead_distance</span> <span class="o">+=</span> <span class="n">segment</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
        <span class="n">segment</span> <span class="o">=</span> <span class="n">segment</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">brake</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<h2>Updating related methods</h2>
<p>Let's make an update in the <code>Drive</code> method such that we accelerate only if we 
are not braking.</p>
<div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">CarController</span><span class="o">::</span><span class="n">Drive</span><span class="p">(</span><span class="n">tSituation</span><span class="o">*</span> <span class="n">situation</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">car</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tCarCtrl</span><span class="p">));</span> <span class="c1">// reset the values</span>

    <span class="kt">float</span> <span class="n">car_angle</span> <span class="o">=</span> <span class="n">CurrentCarAngle</span><span class="p">(</span><span class="n">situation</span><span class="p">);</span>

    <span class="n">car</span><span class="o">-&gt;</span><span class="n">_steerCmd</span> <span class="o">=</span> <span class="n">GetSteering</span><span class="p">(</span><span class="n">car_angle</span><span class="p">);</span>
    <span class="n">car</span><span class="o">-&gt;</span><span class="n">_gearCmd</span> <span class="o">=</span> <span class="n">GetGear</span><span class="p">();</span> 
    <span class="n">car</span><span class="o">-&gt;</span><span class="n">_brakeCmd</span> <span class="o">=</span> <span class="n">GetBrake</span><span class="p">();</span> 
    <span class="k">if</span> <span class="p">(</span><span class="n">car</span><span class="o">-&gt;</span><span class="n">_brakeCmd</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">){</span>
        <span class="n">car</span><span class="o">-&gt;</span><span class="n">_accelCmd</span> <span class="o">=</span> <span class="n">GetAcceleration</span><span class="p">();</span> 
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">car</span><span class="o">-&gt;</span><span class="n">_accelCmd</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Let's fix the gear to 4, for a test drive.</p>
<div class="highlight"><pre><span></span><span class="kt">float</span> <span class="n">CarController</span><span class="o">::</span><span class="n">GetGear</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="mi">4</span><span class="p">;</span> 
<span class="p">}</span>
</pre></div>


<p>Now let's declare the newly defined method within the class declaration in 
<em>carcontroller.h</em>.</p>
<div class="highlight"><pre><span></span>    <span class="kt">float</span> <span class="nf">DistanceFromCarToSegmentEnd</span><span class="p">();</span>
</pre></div>


<p>Time for a test drive.</p>
<p>[insert video]</p>
<h1>Shifting Gears</h1>
<p>We will implement a simple yet efficient gear shifting mecanism. </p>
<p>For now we are only moving forward, so if we are in neutral or reverse, 
we shift to the 1st gear. Otherwise we compute the maximum speed allowed 
at the current gear we are at, by multiplying the angular speed of the 
engine by the wheel radius and a 'shift constant' which represent a percentage 
of the rpm red line. If the product is less than the car speed, we shift up. 
Else, we check if we can shift down by first ensuring we are at a gear higher 
than 1. We then compute the maximum speed allowed at the gear lower than the 
current one. If the maximum speed allowed at the lower gear is lower than our 
current speed, we down shift. Note that we added a shift margin to prevent 
oscillating the gear up and down.</p>
<p>Here is the code for the shifting mechanism, implemented in <code>GetGear()</code></p>
<div class="highlight"><pre><span></span><span class="kt">float</span> <span class="n">CarController</span><span class="o">::</span><span class="n">GetGear</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">car</span><span class="o">-&gt;</span><span class="n">_gear</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="mf">1.0</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">gear_ratio_up</span> <span class="o">=</span> <span class="n">car</span><span class="o">-&gt;</span><span class="n">_gearRatio</span><span class="p">[</span><span class="n">car</span><span class="o">-&gt;</span><span class="n">_gear</span> <span class="o">+</span> <span class="n">car</span><span class="o">-&gt;</span><span class="n">_gearOffset</span><span class="p">];</span>
    <span class="kt">float</span> <span class="n">omega</span> <span class="o">=</span> <span class="n">car</span><span class="o">-&gt;</span><span class="n">_enginerpmRedLine</span> <span class="o">/</span> <span class="n">gear_ratio_up</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">wheel_radius</span> <span class="o">=</span> <span class="n">car</span><span class="o">-&gt;</span><span class="n">_wheelRadius</span><span class="p">(</span><span class="n">REAR_RGT</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">omega</span> <span class="o">*</span> <span class="n">wheel_radius</span> <span class="o">*</span> <span class="n">SHIFT</span> <span class="o">&lt;</span> <span class="n">car</span><span class="o">-&gt;</span><span class="n">_speed_x</span><span class="p">){</span>
        <span class="k">return</span> <span class="n">car</span><span class="o">-&gt;</span><span class="n">_gear</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">car</span><span class="o">-&gt;</span><span class="n">_gear</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">float</span> <span class="n">gear_ratio_down</span> <span class="o">=</span> <span class="n">car</span><span class="o">-&gt;</span><span class="n">_gearRatio</span><span class="p">[</span><span class="n">car</span><span class="o">-&gt;</span><span class="n">_gear</span> <span class="o">+</span> <span class="n">car</span><span class="o">-&gt;</span><span class="n">_gearOffset</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
        <span class="n">omega</span> <span class="o">=</span> <span class="n">car</span><span class="o">-&gt;</span><span class="n">_enginerpmRedLine</span> <span class="o">/</span> <span class="n">gear_ratio_down</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">omega</span> <span class="o">*</span> <span class="n">wheel_radius</span> <span class="o">*</span> <span class="n">SHIFT</span> <span class="o">&lt;</span> <span class="n">car</span><span class="o">-&gt;</span><span class="n">_speed_x</span> <span class="o">+</span> <span class="n">SHIFT_MARGIN</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">car</span><span class="o">-&gt;</span><span class="n">_gear</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">car</span><span class="o">-&gt;</span><span class="n">_gear</span><span class="p">;</span> 
<span class="p">}</span>
</pre></div>


<p>Let's define the new constants at the begining of <em>carcontroller.cpp</em></p>
<div class="highlight"><pre><span></span><span class="k">const</span> <span class="kt">float</span> <span class="n">CarController</span><span class="o">::</span><span class="n">SHIFT</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">;</span> <span class="c1">// [-] (% of rpm red line)</span>
<span class="k">const</span> <span class="kt">float</span> <span class="n">CarController</span><span class="o">::</span><span class="n">SHIFT_MARGIN</span> <span class="o">=</span> <span class="mf">4.0</span><span class="p">;</span> <span class="c1">// [m/s]</span>
</pre></div>


<p>And declare them in <em>carcontroller.h</em></p>
<div class="highlight"><pre><span></span>        <span class="k">static</span> <span class="k">const</span> <span class="kt">float</span> <span class="n">SHIFT</span><span class="p">;</span>
        <span class="k">static</span> <span class="k">const</span> <span class="kt">float</span> <span class="n">SHIFT_MARGIN</span><span class="p">;</span>
</pre></div>


<p>Let's do another test drive</p>
<p>[insert video]</p>
<h1>Considering aerodynamics</h1>
<p>So far, we omitted many variables to simplify computations. Now we will include 
an additional concept that plays a major role on our car performance: aerodynamics. </p>
<p>Aerodynamics can be defined as the study of the motion of air on a solid body. 
The figure below illustrate different aerodynamic forces applied on a car at 
speed: the drag, the lift and the downforce. There are also some other ones like
the yaw moment (not represented here). We will take into account the downforce 
and the drag in our calculations.</p>
<p><img alt="Aerodynamic Forces" src="https://godidier.github.io/images/2019-01/aerodynamics.png"></p>
<p>Going in depth in explanation of aerodynamic phenomenon might be a bit out 
of scope of this tutorial. <del>This chapter is actually a bit lenghty right.</del> 
But if you are interested, some good resources for our topic are: </p>
<ul>
<li><a href="https://www.buildyourownracecar.com/race-car-aerodynamics-basics-and-design/">Race car Aerodynamics basics and design</a></li>
<li><a href="https://www.nas.nasa.gov/About/Education/Racecar/aerodynamics.html">Aerodynamics</a></li>
</ul>
<p>We will revisit the speed limit in turns and the braking mechanism with 
aerodynamics.</p>
<h2>Accessing the default car setup</h2>
<p>Do you remember the directory where we listed the available cars? Well, within 
each car directory there are various files among which an xml one that defines 
our car's properties, including the setup. In our case, the xml properties file 
is at <code>/usr/local/share/games/torcs/cars/car1-trb1/car1-trb1.xml</code>. 
These setup are used by default for our AI agent car.</p>
<p>We will discuss more about managing car setup in coming chapters. For now, we need 
to get some setup from the file, relative to aerodynamics. </p>
<p>One function we will use to access numerical values in the default setup file is 
<code>GfParmGetNum</code>. The sections of interest in <code>car1-trb1.xml</code> is the following: </p>
<div class="highlight"><pre><span></span>    <span class="nt">&lt;section</span> <span class="na">name=</span><span class="s">&quot;Aerodynamics&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;attnum</span> <span class="na">name=</span><span class="s">&quot;Cx&quot;</span> <span class="na">min=</span><span class="s">&quot;0.20&quot;</span> <span class="na">max=</span><span class="s">&quot;2.0&quot;</span> <span class="na">val=</span><span class="s">&quot;0.35&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;attnum</span> <span class="na">name=</span><span class="s">&quot;front area&quot;</span> <span class="na">unit=</span><span class="s">&quot;m2&quot;</span> <span class="na">min=</span><span class="s">&quot;1.0&quot;</span> <span class="na">max=</span><span class="s">&quot;3.0&quot;</span> <span class="na">val=</span><span class="s">&quot;1.92&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;attnum</span> <span class="na">name=</span><span class="s">&quot;front Clift&quot;</span> <span class="na">min=</span><span class="s">&quot;0.0&quot;</span> <span class="na">max=</span><span class="s">&quot;1.5&quot;</span> <span class="na">val=</span><span class="s">&quot;0.69&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;attnum</span> <span class="na">name=</span><span class="s">&quot;rear Clift&quot;</span> <span class="na">min=</span><span class="s">&quot;0.0&quot;</span> <span class="na">max=</span><span class="s">&quot;1.5&quot;</span> <span class="na">val=</span><span class="s">&quot;0.7&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/section&gt;</span>

    <span class="nt">&lt;section</span> <span class="na">name=</span><span class="s">&quot;Front Wing&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;attnum</span> <span class="na">name=</span><span class="s">&quot;area&quot;</span> <span class="na">unit=</span><span class="s">&quot;m2&quot;</span> <span class="na">val=</span><span class="s">&quot;0.25&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;attnum</span> <span class="na">name=</span><span class="s">&quot;angle&quot;</span> <span class="na">unit=</span><span class="s">&quot;deg&quot;</span> <span class="na">min=</span><span class="s">&quot;0&quot;</span> <span class="na">max=</span><span class="s">&quot;12&quot;</span> <span class="na">val=</span><span class="s">&quot;6&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;attnum</span> <span class="na">name=</span><span class="s">&quot;xpos&quot;</span> <span class="na">unit=</span><span class="s">&quot;m&quot;</span> <span class="na">val=</span><span class="s">&quot;2.20&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;attnum</span> <span class="na">name=</span><span class="s">&quot;zpos&quot;</span> <span class="na">unit=</span><span class="s">&quot;m&quot;</span> <span class="na">val=</span><span class="s">&quot;0.04&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/section&gt;</span>

    <span class="nt">&lt;section</span> <span class="na">name=</span><span class="s">&quot;Rear Wing&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;attnum</span> <span class="na">name=</span><span class="s">&quot;area&quot;</span> <span class="na">unit=</span><span class="s">&quot;m2&quot;</span> <span class="na">min=</span><span class="s">&quot;0&quot;</span> <span class="na">max=</span><span class="s">&quot;1.0&quot;</span> <span class="na">val=</span><span class="s">&quot;0.7&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;attnum</span> <span class="na">name=</span><span class="s">&quot;angle&quot;</span> <span class="na">unit=</span><span class="s">&quot;deg&quot;</span> <span class="na">min=</span><span class="s">&quot;0&quot;</span> <span class="na">max=</span><span class="s">&quot;18&quot;</span> <span class="na">val=</span><span class="s">&quot;14&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;attnum</span> <span class="na">name=</span><span class="s">&quot;xpos&quot;</span> <span class="na">unit=</span><span class="s">&quot;m&quot;</span> <span class="na">min=</span><span class="s">&quot;-2.5&quot;</span> <span class="na">max=</span><span class="s">&quot;-1.0&quot;</span> <span class="na">val=</span><span class="s">&quot;-2.01&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;attnum</span> <span class="na">name=</span><span class="s">&quot;zpos&quot;</span> <span class="na">unit=</span><span class="s">&quot;m&quot;</span> <span class="na">min=</span><span class="s">&quot;0.1&quot;</span> <span class="na">max=</span><span class="s">&quot;1.5&quot;</span> <span class="na">val=</span><span class="s">&quot;0.99&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
</pre></div>


<h2>Aerodynamics in the speed limitation</h2>
<p>Let's include the downforce in the equation we previously used to find the speed 
limit in turns. </p>
<div class="math">$$
\begin{align*}
\underbrace{\frac{m \cdot v^2}{r}}_{\text{Centrifugal force}}&amp; = 
\underbrace{m \cdot g \cdot \mu}_{\text{Friction force}} + 
\underbrace{C_a \cdot v^2 \cdot \mu}_{\text{Aerodynamic downforce}} \\
v^2&amp; = \frac{g \cdot \mu \cdot r}{1 - r \cdot C_a \cdot \mu / m} \\
v&amp; = \sqrt{\frac{g \cdot \mu \cdot r}{1 - min(1, \frac{r \cdot C_a \cdot \mu}{m})}}
\end{align*}
$$</div>
<p>Where <span class="math">\(C_a\)</span> is the downforce coefficient. The downforce coefficient can be 
considered a fixed value computed using the density of the air, the area, shape 
and angle of attack of the car's wing and the ride height which is the distance 
between the ground and the car's bottom. Two things actually contribute to 
the downforce: the car wings which act like an inverted airplane wing to keep
the car on the ground, and the ground effect which is cause by the flow of air 
between the car and the ground. The downforce is a performance advantage on 
cars with wings and a specially designed chasis.</p>
<p>When solving the equation for <span class="math">\(v\)</span> there is a risk of getting a negative number 
under the square root (a complex number), in case <span class="math">\(r \cdot C_a \cdot \mu / m\)</span> 
becomes greater than 1. To avoid that we use the minimum function to put 
a restriction.</p>
<p>Let's start the implementation with the method that initialize the downforce 
coefficient.</p>
<div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Initialize the aerodynamic coefficient CA of the car.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">CarController</span><span class="o">::</span><span class="n">InitCa</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">float</span> <span class="n">air_density</span> <span class="o">=</span> <span class="mf">1.23</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">rear_wing_area</span> <span class="o">=</span> <span class="n">GfParmGetNum</span><span class="p">(</span><span class="n">car</span><span class="o">-&gt;</span><span class="n">_carHandle</span><span class="p">,</span> <span class="n">SECT_REARWING</span><span class="p">,</span> 
                    <span class="n">PRM_WINGAREA</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">rear_wing_angle</span> <span class="o">=</span> <span class="n">GfParmGetNum</span><span class="p">(</span><span class="n">car</span><span class="o">-&gt;</span><span class="n">_carHandle</span><span class="p">,</span> <span class="n">SECT_REARWING</span><span class="p">,</span> 
                    <span class="n">PRM_WINGANGLE</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">front_ground_effect</span> <span class="o">=</span> <span class="n">GfParmGetNum</span><span class="p">(</span><span class="n">car</span><span class="o">-&gt;</span><span class="n">_carHandle</span><span class="p">,</span> <span class="n">SECT_AERODYNAMICS</span><span class="p">,</span> 
                    <span class="n">PRM_FCL</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">rear_ground_effect</span> <span class="o">=</span> <span class="n">GfParmGetNum</span><span class="p">(</span><span class="n">car</span><span class="o">-&gt;</span><span class="n">_carHandle</span><span class="p">,</span> <span class="n">SECT_AERODYNAMICS</span><span class="p">,</span> 
                    <span class="n">PRM_RCL</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>

    <span class="kt">float</span> <span class="n">front_right_height</span> <span class="o">=</span> <span class="n">GfParmGetNum</span><span class="p">(</span><span class="n">car</span><span class="o">-&gt;</span><span class="n">_carHandle</span><span class="p">,</span> <span class="n">SECT_FRNTRGTWHEEL</span><span class="p">,</span> 
                    <span class="n">PRM_RIDEHEIGHT</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">front_left_height</span> <span class="o">=</span> <span class="n">GfParmGetNum</span><span class="p">(</span><span class="n">car</span><span class="o">-&gt;</span><span class="n">_carHandle</span><span class="p">,</span> <span class="n">SECT_FRNTLFTWHEEL</span><span class="p">,</span> 
                    <span class="n">PRM_RIDEHEIGHT</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">rear_right_height</span> <span class="o">=</span> <span class="n">GfParmGetNum</span><span class="p">(</span><span class="n">car</span><span class="o">-&gt;</span><span class="n">_carHandle</span><span class="p">,</span> <span class="n">SECT_REARRGTWHEEL</span><span class="p">,</span> 
                    <span class="n">PRM_RIDEHEIGHT</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">rear_left_height</span> <span class="o">=</span> <span class="n">GfParmGetNum</span><span class="p">(</span><span class="n">car</span><span class="o">-&gt;</span><span class="n">_carHandle</span><span class="p">,</span> <span class="n">SECT_REARLFTWHEEL</span><span class="p">,</span> 
                    <span class="n">PRM_RIDEHEIGHT</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">);</span>

    <span class="kt">float</span> <span class="n">wing_ca</span> <span class="o">=</span> <span class="n">air_density</span> <span class="o">*</span> <span class="n">rear_wing_area</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">rear_wing_angle</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">Cl</span> <span class="o">=</span> <span class="n">front_ground_effect</span> <span class="o">+</span> <span class="n">rear_ground_effect</span><span class="p">;</span>

    <span class="kt">float</span> <span class="n">ride_height</span> <span class="o">=</span> <span class="n">front_right_height</span> <span class="o">+</span> <span class="n">front_left_height</span> 
            <span class="o">+</span> <span class="n">rear_right_height</span> <span class="o">+</span> <span class="n">rear_left_height</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">h</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span> <span class="o">-</span><span class="mf">3.0</span> <span class="o">*</span> <span class="n">pow</span><span class="p">(</span><span class="n">ride_height</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>

    <span class="n">CA</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">Cl</span> <span class="o">+</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">wing_ca</span><span class="p">;</span>

<span class="p">}</span>
</pre></div>


<p>We can now change the last line of <code>GetAllowedSpeed(tTrackSeg* segment)</code> from</p>
<div class="highlight"><pre><span></span>        <span class="k">return</span> <span class="nf">sqrt</span><span class="p">(</span><span class="n">mu</span> <span class="o">*</span> <span class="n">G</span> <span class="o">*</span> <span class="n">r</span><span class="p">);</span>
</pre></div>


<p>to </p>
<div class="highlight"><pre><span></span>        <span class="k">return</span> <span class="nf">sqrt</span><span class="p">((</span><span class="n">mu</span> <span class="o">*</span> <span class="n">G</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">MIN</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span> <span class="n">CA</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">/</span> <span class="n">full_car_mass</span><span class="p">)));</span>
</pre></div>


<p>In order to take into account the aerodynamic downforce when we compute the 
maximum allowed speed in turns.
We modify the <code>NewRace(...)</code> method to initialize the mass of the car and the 
the downforce coefficient by calling <code>InitCa()</code>.</p>
<div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">CarController</span><span class="o">::</span><span class="n">NewRace</span><span class="p">(</span><span class="n">tCarElt</span><span class="o">*</span> <span class="n">car</span><span class="p">,</span> <span class="n">tSituation</span><span class="o">*</span> <span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">car</span> <span class="o">=</span> <span class="n">car</span><span class="p">;</span>
    <span class="n">car_mass</span> <span class="o">=</span> <span class="n">GfParmGetNum</span><span class="p">(</span><span class="n">car</span><span class="o">-&gt;</span><span class="n">_carHandle</span><span class="p">,</span> <span class="n">SECT_CAR</span><span class="p">,</span> <span class="n">PRM_MASS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mf">1000.0</span><span class="p">);</span>
    <span class="n">InitCa</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>


<p>We also have to update the car mass. We do it in the <code>CarController::Drive(...)</code> 
function, just after the <code>memset(...)</code> line. </p>
<div class="highlight"><pre><span></span><span class="c1">//...</span>
    <span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">car</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tCarCtrl</span><span class="p">));</span> <span class="c1">// reset the values</span>

    <span class="n">full_car_mass</span> <span class="o">=</span> <span class="n">car_mass</span> <span class="o">+</span> <span class="n">car</span><span class="o">-&gt;</span><span class="n">_fuel</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">car_angle</span> <span class="o">=</span> <span class="n">CurrentCarAngle</span><span class="p">(</span><span class="n">situation</span><span class="p">);</span>
<span class="c1">//...</span>
</pre></div>


<p>Now let's add the declaration of the new class members in <em>carcontroller.h</em>.</p>
<div class="highlight"><pre><span></span>    <span class="k">private</span><span class="o">:</span>
        <span class="c1">//...</span>
        <span class="kt">void</span> <span class="n">InitCa</span><span class="p">();</span>

        <span class="c1">//...</span>

        <span class="kt">float</span> <span class="n">car_mass</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">full_car_mass</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">CA</span><span class="p">;</span>

        <span class="c1">//...</span>
</pre></div>


<p>The graph below show a comparison of the maximum speed that can be reach 
in turns in relation to the radius of the turn,
between the old and the new <code>GetAllowedSpeed(tTrackSeg* segment)</code> method.</p>
<p><img alt="Comparison" src="{static}/#"></p>
<h3>Test drive</h3>
<p>lap time</p>
<h2>Aerodynamics in braking</h2>
<p>We will make use of the aerodynamic downforce and the drag in our calculations. 
This will allow us to break later and smoothen the braking pattern when driving. </p>
<p>All right, the next formula maybe intimidating but, take a deep breath and stay 
with me <del>please</del>... Let's rewrite the energy conservation equation 
we used to compute the braking distance, by including the downforce and the 
drag.</p>
<div class="math">$$
\underbrace{\frac{m \cdot v_1^2}{2}}_{\text{Current kinetic energy}} - 
\underbrace{\frac{m \cdot v_2^2}{2}}_{\text{Desired kinetic energy}} = 
\underbrace{m \cdot g \cdot \mu \cdot s + C_a \cdot \int_{s_2}^{s_1} v^2(s) ds \cdot \mu }_{\text{Energy burned by brake}} +
\underbrace{C_w \cdot \int_{s_1}^{s_2} v^2(s) ds}_{\text{air resistance energy (drag)}}
$$</div>
<p>...Ah, that is enough math for today... So here is the braking distance we get when solving the equation.</p>
<div class="math">$$
s = - \frac{ln((c + v_2^2 \cdot d) / (c + v_1^2 \cdot d))}{2 \cdot d}
$$</div>
<p>With <span class="math">\(c = g \cdot \mu\)</span> and <span class="math">\(d = (C_a \cdot \mu + C_w) / m\)</span>: </p>
<p><span class="math">\(C_w\)</span> is the drag coefficient. The drag coefficient is computed using ...</p>
<p>Here is the implementation of the initialization of <span class="math">\(C_w\)</span></p>
<div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Initialize the aerodynamic drag coefficient Cw</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">CarController</span><span class="o">::</span><span class="n">InitCw</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">float</span> <span class="n">Cx</span> <span class="o">=</span> <span class="n">GfParmGetNum</span><span class="p">(</span><span class="n">car</span><span class="o">-&gt;</span><span class="n">_carHandle</span><span class="p">,</span> <span class="n">SECT_AERODYNAMICS</span><span class="p">,</span> 
                    <span class="n">PRM_CX</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">front_area</span> <span class="o">=</span> <span class="n">GfParmGetNum</span><span class="p">(</span><span class="n">car</span><span class="o">-&gt;</span><span class="n">_carHandle</span><span class="p">,</span> <span class="n">SECT_AERODYNAMICS</span><span class="p">,</span> 
                    <span class="n">PRM_FRNTAREA</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
    <span class="n">CW</span> <span class="o">=</span> <span class="mf">0.645</span> <span class="o">*</span> <span class="n">Cx</span> <span class="o">*</span> <span class="n">front_area</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>Now we change the following line from <code>GetBrake(...)</code> </p>
<div class="highlight"><pre><span></span>            <span class="kt">float</span> <span class="n">brake_distance</span> <span class="o">=</span> 
                    <span class="p">(</span><span class="n">pow</span><span class="p">(</span><span class="n">speed</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">pow</span><span class="p">(</span><span class="n">allowed_speed</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">*</span> <span class="n">G</span><span class="p">);</span>
</pre></div>


<p>to </p>
<div class="highlight"><pre><span></span>            <span class="kt">float</span> <span class="n">brake_distance</span> <span class="o">=</span> 
                    <span class="o">-</span> <span class="n">log</span><span class="p">((</span><span class="n">c</span> <span class="o">+</span> <span class="n">pow</span><span class="p">(</span><span class="n">allowed_speed</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="n">pow</span><span class="p">(</span><span class="n">speed</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">d</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">d</span><span class="p">);</span> 
</pre></div>


<p>We declare the new class members in <em>carcontroller.h</em></p>
<div class="highlight"><pre><span></span>    <span class="k">private</span><span class="o">:</span>
        <span class="c1">//...</span>
        <span class="kt">void</span> <span class="n">InitCw</span><span class="p">();</span>

        <span class="c1">//...</span>
        <span class="kt">float</span> <span class="n">CW</span><span class="p">;</span>
</pre></div>


<p>and we call <code>InitCw(...)</code> at the end of <code>NewRace(...)</code>.</p>
<div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">CarController</span><span class="o">::</span><span class="n">NewRace</span><span class="p">(</span><span class="n">tCarElt</span><span class="o">*</span> <span class="n">car</span><span class="p">,</span> <span class="n">tSituation</span><span class="o">*</span> <span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//...</span>
    <span class="n">InitCw</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>


<p>[Show performance improvement with a plot]
for integral plotting check
<em> https://matplotlib.org/gallery/showcase/integral.html
</em> https://matplotlib.org/api/_as_gen/matplotlib.pyplot.plot.html</p>
<h3>Test drive</h3>
<p>Lap time</p>
<h1>Stability Control</h1>
<p>During the test drive you may have notice the car wheels slide at some points 
(leaving marks on the track). This is due to accelerating and braking too hard. 
We will use some stability control approaches to alleviate this phenomenon.</p>
<p>Stability controls are mechanisms that improve the stability of a car while driving.
There are different stability control systems among which the Antilock Brake System
(ABS) and Traction Control (TCL) that we will implement to assist our AI agent 
driving.</p>
<h2>Antilock Brake System (ABS)</h2>
<p>Wheel lock is caused by ...
Anti wheel locking system we will implement will...</p>
<p>implementation </p>
<div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Brakes ABS filter</span>
<span class="cm"> */</span>
<span class="kt">float</span> <span class="n">CarController</span><span class="o">::</span><span class="n">FilterABS</span><span class="p">(</span><span class="kt">float</span> <span class="n">brake</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">car</span><span class="o">-&gt;</span><span class="n">_speed_x</span> <span class="o">&lt;</span> <span class="n">ABS_MIN_SPEED</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">brake</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">slip</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">slip</span> <span class="o">+=</span> <span class="n">car</span><span class="o">-&gt;</span><span class="n">_wheelSpinVel</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">car</span><span class="o">-&gt;</span><span class="n">_wheelRadius</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">car</span><span class="o">-&gt;</span><span class="n">_speed_x</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">slip</span> <span class="o">=</span> <span class="n">slip</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">slip</span> <span class="o">&lt;</span> <span class="n">ABS_SLIP</span><span class="p">){</span>
        <span class="n">brake</span> <span class="o">=</span> <span class="n">brake</span> <span class="o">*</span> <span class="n">slip</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">brake</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>We apply the filter by adding the following line at the end of <code>GetBrake(...)</code>
just above the return statement,</p>
<div class="highlight"><pre><span></span><span class="kt">float</span> <span class="n">CarController</span><span class="o">::</span><span class="n">GetBrake</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="n">brake</span> <span class="o">=</span> <span class="n">FilterABS</span><span class="p">(</span><span class="n">brake</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">brake</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>We also add the new constant to <em>carcontroller.cpp</em></p>
<div class="highlight"><pre><span></span><span class="k">const</span> <span class="kt">float</span> <span class="n">CarController</span><span class="o">::</span><span class="n">ABS_SLIP</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">;</span> <span class="c1">// [-] range [0.95..0.3]</span>
<span class="k">const</span> <span class="kt">float</span> <span class="n">CarController</span><span class="o">::</span><span class="n">ABS_MIN_SPEED</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">;</span> <span class="c1">// [m/s]</span>
</pre></div>


<p>and we update <em>carcontroller.h</em> with the new class members. </p>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>
    <span class="k">public</span><span class="o">:</span>
        <span class="c1">// ...</span>
        <span class="k">static</span> <span class="k">const</span> <span class="kt">float</span> <span class="n">ABS_SLIP</span><span class="p">;</span>
        <span class="k">static</span> <span class="k">const</span> <span class="kt">float</span> <span class="n">ABS_MIN_SPEED</span><span class="p">;</span>

    <span class="k">private</span><span class="o">:</span>
        <span class="c1">// ...</span>
        <span class="kt">float</span> <span class="n">FilterABS</span><span class="p">(</span><span class="kt">float</span> <span class="n">brake</span><span class="p">);</span>

<span class="c1">// ...</span>
</pre></div>


<h2>Traction Control (TCL)</h2>
<p>Wheel slips when ...</p>
<p>Implementation ... 
used a pointer to function </p>
<div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Acceleration TCL filter</span>
<span class="cm"> */</span>
<span class="kt">float</span> <span class="n">CarController</span><span class="o">::</span><span class="n">FilterTCL</span><span class="p">(</span><span class="kt">float</span> <span class="n">acceleration</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">car</span><span class="o">-&gt;</span><span class="n">_speed_x</span> <span class="o">&lt;</span> <span class="n">TCL_MIN_SPEED</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">acceleration</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">wheel_speed</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;*</span><span class="n">GetDrivenWheelSpeed</span><span class="p">)();</span>
    <span class="kt">float</span> <span class="n">slip</span> <span class="o">=</span> <span class="n">car</span><span class="o">-&gt;</span><span class="n">_speed_x</span> <span class="o">/</span> <span class="n">wheel_speed</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">slip</span> <span class="o">&lt;</span> <span class="n">TCL_SLIP</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">acceleration</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">acceleration</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>Select spinning wheel... function to point to</p>
<div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Select the right spinning wheel speed calculation for the TCL filter</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">CarController</span><span class="o">::</span><span class="n">InitDrivenWheelSpeed</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">train_type</span> <span class="o">=</span> <span class="n">GfParmGetStr</span><span class="p">(</span><span class="n">car</span><span class="o">-&gt;</span><span class="n">_carHandle</span><span class="p">,</span> <span class="n">SECT_DRIVETRAIN</span><span class="p">,</span> 
                    <span class="n">PRM_TYPE</span><span class="p">,</span> <span class="n">VAL_TRANS_RWD</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">train_type</span><span class="p">,</span> <span class="n">VAL_TRANS_RWD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">GetDrivenWheelSpeed</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">CarController</span><span class="o">::</span><span class="n">GetWheelSpeedRWD</span><span class="p">;</span> 
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">train_type</span><span class="p">,</span> <span class="n">VAL_TRANS_FWD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
        <span class="n">GetDrivenWheelSpeed</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">CarController</span><span class="o">::</span><span class="n">GetWheelSpeedFWD</span><span class="p">;</span> 
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">train_type</span><span class="p">,</span> <span class="n">VAL_TRANS_4WD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
        <span class="n">GetDrivenWheelSpeed</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">CarController</span><span class="o">::</span><span class="n">GetWheelSpeed4WD</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Computing the wheel speed for different train type</p>
<div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Get the driven wheel speed for Rear Wheel Drive (RWD)</span>
<span class="cm"> */</span>
<span class="kt">float</span> <span class="n">CarController</span><span class="o">::</span><span class="n">GetWheelSpeedRWD</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">car</span><span class="o">-&gt;</span><span class="n">_wheelSpinVel</span><span class="p">(</span><span class="n">REAR_RGT</span><span class="p">)</span> <span class="o">+</span> <span class="n">car</span><span class="o">-&gt;</span><span class="n">_wheelSpinVel</span><span class="p">(</span><span class="n">REAR_LFT</span><span class="p">))</span> <span class="o">*</span> 
            <span class="n">car</span><span class="o">-&gt;</span><span class="n">_wheelRadius</span><span class="p">(</span><span class="n">REAR_LFT</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Get the driven wheel speed for Front Wheel Drive (FWD)</span>
<span class="cm"> */</span>
<span class="kt">float</span> <span class="n">CarController</span><span class="o">::</span><span class="n">GetWheelSpeedFWD</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">car</span><span class="o">-&gt;</span><span class="n">_wheelSpinVel</span><span class="p">(</span><span class="n">FRNT_RGT</span><span class="p">)</span> <span class="o">+</span> <span class="n">car</span><span class="o">-&gt;</span><span class="n">_wheelSpinVel</span><span class="p">(</span><span class="n">FRNT_LFT</span><span class="p">))</span> <span class="o">*</span> 
            <span class="n">car</span><span class="o">-&gt;</span><span class="n">_wheelRadius</span><span class="p">(</span><span class="n">FRNT_LFT</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Get the driven wheel speed for Four Wheel Drive (4WD)</span>
<span class="cm"> */</span>
<span class="kt">float</span> <span class="n">CarController</span><span class="o">::</span><span class="n">GetWheelSpeed4WD</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span> <span class="p">(</span><span class="n">car</span><span class="o">-&gt;</span><span class="n">_wheelSpinVel</span><span class="p">(</span><span class="n">REAR_RGT</span><span class="p">)</span> <span class="o">+</span> <span class="n">car</span><span class="o">-&gt;</span><span class="n">_wheelSpinVel</span><span class="p">(</span><span class="n">REAR_LFT</span><span class="p">))</span> <span class="o">*</span> 
                <span class="n">car</span><span class="o">-&gt;</span><span class="n">_wheelRadius</span><span class="p">(</span><span class="n">REAR_LFT</span><span class="p">)</span> <span class="o">+</span>
            <span class="p">(</span><span class="n">car</span><span class="o">-&gt;</span><span class="n">_wheelSpinVel</span><span class="p">(</span><span class="n">FRNT_RGT</span><span class="p">)</span> <span class="o">+</span> <span class="n">car</span><span class="o">-&gt;</span><span class="n">_wheelSpinVel</span><span class="p">(</span><span class="n">FRNT_LFT</span><span class="p">))</span> <span class="o">*</span> 
                <span class="n">car</span><span class="o">-&gt;</span><span class="n">_wheelRadius</span><span class="p">(</span><span class="n">FRNT_LFT</span><span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>To apply the TCL filter add the following line at the end of  <code>GetAcceleration()</code>
before the <code>return</code> statement.</p>
<div class="highlight"><pre><span></span><span class="kt">float</span> <span class="n">CarController</span><span class="o">::</span><span class="n">GetAcceleration</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="n">acceleration</span> <span class="o">=</span> <span class="n">FilterTCL</span><span class="p">(</span><span class="n">acceleration</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">acceleration</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>add <code>InitDrivenWheelSpeed();</code> in <code>NewRace(...)</code> to set the wheel speed 
calculation pointer function to the right one.</p>
<div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">CarController</span><span class="o">::</span><span class="n">NewRace</span><span class="p">(</span><span class="n">tCarElt</span><span class="o">*</span> <span class="n">car</span><span class="p">,</span> <span class="n">tSituation</span><span class="o">*</span> <span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="n">InitDrivenWheelSpeed</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>


<p>We define the new constant in <em>carcontroller.cpp</em>,</p>
<div class="highlight"><pre><span></span><span class="k">const</span> <span class="kt">float</span> <span class="n">CarController</span><span class="o">::</span><span class="n">TCL_SLIP</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">;</span> <span class="c1">// [-] range [0.95..0.3]</span>
<span class="k">const</span> <span class="kt">float</span> <span class="n">CarController</span><span class="o">::</span><span class="n">TCL_MIN_SPEED</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">;</span> <span class="c1">// [m/s]</span>
</pre></div>


<p>and add the new class member declaration in <em>carcontroller.h</em>.</p>
<div class="highlight"><pre><span></span><span class="c1">// ...</span>
    <span class="k">public</span><span class="o">:</span> 
        <span class="c1">// ...</span>
        <span class="k">static</span> <span class="k">const</span> <span class="kt">float</span> <span class="n">TCL_SLIP</span><span class="p">;</span>
        <span class="k">static</span> <span class="k">const</span> <span class="kt">float</span> <span class="n">TCL_MIN_SPEED</span><span class="p">;</span>

    <span class="k">private</span><span class="o">:</span>
        <span class="c1">// ...</span>
        <span class="kt">float</span> <span class="n">FilterTCL</span><span class="p">(</span><span class="kt">float</span> <span class="n">acceleration</span><span class="p">);</span>
        <span class="kt">float</span> <span class="nf">GetWheelSpeedRWD</span><span class="p">();</span>
        <span class="kt">float</span> <span class="nf">GetWheelSpeedFWD</span><span class="p">();</span>
        <span class="kt">float</span> <span class="nf">GetWheelSpeed4WD</span><span class="p">();</span>
        <span class="kt">void</span> <span class="nf">InitDrivenWheelSpeed</span><span class="p">();</span>

        <span class="kt">float</span> <span class="p">(</span><span class="n">CarController</span><span class="o">::*</span><span class="n">GetDrivenWheelSpeed</span><span class="p">)();</span>
<span class="c1">// ...</span>
</pre></div>


<h3>Test Drive</h3>
<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width < 768) ? "left" : align;
        indent = (screen.width < 768) ? "0em" : indent;
        linebreak = (screen.width < 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    var location_protocol = (false) ? 'https' : document.location.protocol;
    if (location_protocol !== 'http' && location_protocol !== 'https') location_protocol = 'https:';
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = location_protocol + '//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
    mathjaxscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' }, Macros: {} }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>
  </div>

</article>


  </main>
    <footer>
      <div class="author__logo">
          <img src="https://godidier.github.io/theme/images/logo.png" alt="logo">
      </div>
      <section class="author">
        <div class="author__name">
          <a href="https://godidier.github.io/pages/about.html">Didier Gohourou</a>
          <p></p>
        </div>
        <div class="author__link">
          <ul>
            <!--<li><a href="#" title="About"><i class="fab fa-link"></i></a></li>-->
			<li style="font-size:10px;"><a href="#" title="About">About | </a></li>
            <!--<li><a href="http://python.org/" title="Python.org"><i class="fab fa-link"></i></a></li>-->
			<li style="font-size:10px;"><a href="http://python.org/" title="Python.org">Python.org | </a></li>
            <!--<li><a href="http://jinja.pocoo.org/" title="Jinja2"><i class="fab fa-link"></i></a></li>-->
			<li style="font-size:10px;"><a href="http://jinja.pocoo.org/" title="Jinja2">Jinja2 | </a></li>
            <!--<li><a href="#" title="You can modify those links in your config file"><i class="fab fa-link"></i></a></li>-->
			<li style="font-size:10px;"><a href="#" title="You can modify those links in your config file">You can modify those links in your config file | </a></li>
          </ul>
          <ul>
            <li>
              <a href="#" target="_blank" title="You can add links in your config file">
              </a>
            </li>
            <li>
              <a href="#" target="_blank" title="Another social link">
              </a>
            </li>
            <li>
              <a href="#" target="_blank" title="facebook">
                <i class="fab fa-facebook-square"></i>
              </a>
            </li>
            <li>
              <a href="#" target="_blank" title="twitter">
                <i class="fab fa-twitter-square"></i>
              </a>
            </li>
          </ul>
        </div>
      </section>
	  <section >
		<ul class="listlinks">
          <li><a href="https://godidier.github.io/#">About</a></li>
          <li><a href="https://godidier.github.io/http://python.org/">Python.org</a></li>
          <li><a href="https://godidier.github.io/http://jinja.pocoo.org/">Jinja2</a></li>
          <li><a href="https://godidier.github.io/#">You can modify those links in your config file</a></li>
		</ul>
	  </section>
      <div class="ending-message">
        <p>&copy; Didier Gohourou. Powered by <a href="http://getpelican.com" target="_blank">Pelican</a>, Theme is using <a href="https://github.com/laughk/pelican-hss" target="_blank">HSS</a>. </p>
      </div>
    </footer>
</body>
</html>